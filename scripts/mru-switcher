#!/usr/bin/env bash
# MRU Switcher - Main interface for tmux-mru window switching

# Get environment variables from tmux
DATA_DIR="${MRU_DATA_DIR:-$HOME/.tmux/plugins/tmux-mru/data}"
SCRIPTS_DIR="${MRU_SCRIPTS_DIR:-$(dirname "$0")}"
POPUP_WIDTH="${MRU_POPUP_WIDTH:-70%}"
POPUP_HEIGHT="${MRU_POPUP_HEIGHT:-50%}"
VIM_MODE="${MRU_VIM_MODE:-off}"
HISTORY_FILE="$DATA_DIR/mru-history"

# Check dependencies
check_dependencies() {
    if ! command -v fzf >/dev/null 2>&1; then
        tmux display-message "Error: fzf not found. Please install fzf to use tmux-mru."
        return 1
    fi
    
    # Check tmux version for popup support
    local tmux_version=$(tmux -V | cut -d' ' -f2 | tr -d 'v')
    local major_version=$(echo "$tmux_version" | cut -d'.' -f1)
    local minor_version=$(echo "$tmux_version" | cut -d'.' -f2)
    
    if [ "$major_version" -lt 3 ] || ([ "$major_version" -eq 3 ] && [ "$minor_version" -lt 2 ]); then
        echo "fallback"
    else
        echo "popup"
    fi
}

# Get current session and window info
get_current_info() {
    local current_session=$(tmux display-message -p '#S')
    local current_window=$(tmux display-message -p '#I')
    echo "$current_session:$current_window"
}

# Generate MRU list excluding current window
generate_mru_list() {
    local current_info=$(get_current_info)
    
    if [ ! -s "$HISTORY_FILE" ]; then
        # No history, show all windows except current
        tmux list-windows -a -F "#{session_name}:#{window_index}:#{window_name}" | \
            grep -v "^$current_info:" | head -10
        return
    fi
    
    # Show MRU history excluding current window
    while IFS=: read -r timestamp session window name; do
        local session_window="$session:$window"
        if [ "$session_window" != "$current_info" ]; then
            # Verify window still exists
            if tmux list-windows -a -F "#{session_name}:#{window_index}" | grep -q "^$session_window$"; then
                echo "$session:$window:$name"
            fi
        fi
    done < "$HISTORY_FILE"
}

# Format window list for display
format_for_display() {
    while IFS=: read -r session window name; do
        printf "%s:%s\n" "$window" "$name"
    done
}

# Generate key bindings based on vim mode
generate_key_bindings() {
    local bindings=""
    
    if [ "$VIM_MODE" = "on" ]; then
        # Vim-style key bindings
        bindings="$bindings --bind=j:down"
        bindings="$bindings --bind=k:up" 
        bindings="$bindings --bind=home:first"
        bindings="$bindings --bind=end:last"
        bindings="$bindings --bind=ctrl-d:half-page-down"
        bindings="$bindings --bind=ctrl-u:half-page-up"
        bindings="$bindings --bind=q:abort"
        bindings="$bindings --bind=/:jump"
        
        # Direct window access with number prefixes (1-9)
        # Note: Using single key for simplicity, vim :1 :2 syntax is complex for fzf
        # Users can still press 1, 2, 3 directly for position access
    fi
    
    # Standard number key bindings (works in both modes)
    bindings="$bindings --bind=1:pos(1)+accept"
    bindings="$bindings --bind=2:pos(2)+accept" 
    bindings="$bindings --bind=3:pos(3)+accept"
    bindings="$bindings --bind=4:pos(4)+accept"
    bindings="$bindings --bind=5:pos(5)+accept"
    bindings="$bindings --bind=6:pos(6)+accept"
    bindings="$bindings --bind=7:pos(7)+accept"
    bindings="$bindings --bind=8:pos(8)+accept"
    bindings="$bindings --bind=9:pos(9)+accept"
    
    echo "$bindings"
}

# Switch to selected window
switch_to_window() {
    local selection="$1"
    
    if [ -z "$selection" ]; then
        return 1
    fi
    
    # Extract window index and name from selection (format: "window:name")
    local window_index=$(echo "$selection" | cut -d: -f1)
    local window_name=$(echo "$selection" | cut -d: -f2)
    
    # Find the session that contains this window index with matching name
    local session_window=$(tmux list-windows -a -F "#{session_name}:#{window_index}:#{window_name}" | \
        grep ":$window_index:$window_name$" | head -1 | cut -d: -f1-2)
    
    if [ -n "$session_window" ]; then
        tmux select-window -t "$session_window"
        # Update MRU history
        "$SCRIPTS_DIR/mru-tracker" update
    fi
}

# Main popup interface
show_popup() {
    local mru_list=$(generate_mru_list)
    
    if [ -z "$mru_list" ]; then
        tmux display-message "No other windows available"
        return 1
    fi
    
    # Create temporary script for fzf preview
    local preview_script=$(mktemp)
    cat > "$preview_script" << 'EOF'
#!/bin/bash
input="$1"
# Parse new format: "window:name"
window=$(echo "$input" | cut -d: -f1)
historical_name=$(echo "$input" | cut -d: -f2)

# Strategy 1: Find session with exact window index and name match
session_window=$(tmux list-windows -a -F "#{session_name}:#{window_index}:#{window_name}" | \
    grep ":$window:$historical_name$" | head -1)

if [ -n "$session_window" ]; then
    # Exact match found
    session=$(echo "$session_window" | cut -d: -f1)
    current_name="$historical_name"
else
    # Strategy 2: Fallback - find by window index only (name may have changed)
    session_window=$(tmux list-windows -a -F "#{session_name}:#{window_index}:#{window_name}" | \
        grep ":$window:" | head -1)
    
    if [ -n "$session_window" ]; then
        session=$(echo "$session_window" | cut -d: -f1)
        current_name=$(echo "$session_window" | cut -d: -f3)
        echo "Note: Window name changed from '$historical_name' to '$current_name'"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    else
        echo "Error: Window $window not found in any session"
        echo "This window may have been closed or moved"
        exit 1
    fi
fi

SCRIPTS_DIR="$MRU_SCRIPTS_DIR"
"$SCRIPTS_DIR/mru-preview" "$session" "$window" "$current_name"
EOF
    chmod +x "$preview_script"
    
    # Generate key bindings based on mode
    local key_bindings=$(generate_key_bindings)
    
    # Create header based on vim mode
    local header
    if [ "$VIM_MODE" = "on" ]; then
        header="ðŸ”„ Recent Windows (Ctrl+J/K: navigate, Ctrl+L: select, 1-9: direct, /: search, Ctrl+Q: quit)"
    else
        header="ðŸ”„ Recent Windows (â†‘/â†“: navigate, 1-9: direct, Esc: cancel)"
    fi
    
    # Use fzf for selection with preview and dynamic bindings
    if [ "$VIM_MODE" = "on" ]; then
        local selection=$(echo "$mru_list" | format_for_display | \
            fzf --reverse \
                --height=40% \
                --border \
                --header="$header" \
                --preview="$preview_script {}" \
                --preview-window="right:50%:wrap" \
                --bind=ctrl-j:down \
                --bind=ctrl-k:up \
                --bind=ctrl-l:accept \
                --bind=home:first \
                --bind=end:last \
                --bind=ctrl-d:half-page-down \
                --bind=ctrl-u:half-page-up \
                --bind=ctrl-q:abort \
                --bind=/:jump \
                --bind=1:pos\(1\)+accept \
                --bind=2:pos\(2\)+accept \
                --bind=3:pos\(3\)+accept \
                --bind=4:pos\(4\)+accept \
                --bind=5:pos\(5\)+accept \
                --bind=6:pos\(6\)+accept \
                --bind=7:pos\(7\)+accept \
                --bind=8:pos\(8\)+accept \
                --bind=9:pos\(9\)+accept)
    else
        local selection=$(echo "$mru_list" | format_for_display | \
            fzf --reverse \
                --height=40% \
                --border \
                --header="$header" \
                --preview="$preview_script {}" \
                --preview-window="right:50%:wrap" \
                --bind=1:pos\(1\)+accept \
                --bind=2:pos\(2\)+accept \
                --bind=3:pos\(3\)+accept \
                --bind=4:pos\(4\)+accept \
                --bind=5:pos\(5\)+accept \
                --bind=6:pos\(6\)+accept \
                --bind=7:pos\(7\)+accept \
                --bind=8:pos\(8\)+accept \
                --bind=9:pos\(9\)+accept)
    fi
    
    # Clean up temporary script
    rm -f "$preview_script"
    
    if [ -n "$selection" ]; then
        switch_to_window "$selection"
    fi
}

# Fallback interface for older tmux versions
show_fallback() {
    local mru_list=$(generate_mru_list)
    
    if [ -z "$mru_list" ]; then
        tmux display-message "No other windows available"
        return 1
    fi
    
    # Create menu items for tmux display-menu
    local menu_items=""
    local counter=1
    
    while IFS=: read -r session window name; do
        if [ $counter -le 9 ]; then
            menu_items="$menu_items \"$window:$name\" \"$counter\" \"select-window -t $session:$window ; run-shell '$SCRIPTS_DIR/mru-tracker update'\""
        fi
        counter=$((counter + 1))
    done <<< "$mru_list"
    
    if [ -n "$menu_items" ]; then
        eval "tmux display-menu -T \"Recent Windows\" $menu_items"
    else
        tmux display-message "No recent windows to display"
    fi
}

# Main execution
main() {
    local ui_mode=$(check_dependencies)
    
    if [ "$ui_mode" = "popup" ]; then
        # Check if we can use tmux popup
        if tmux display-popup -h 1 -w 1 echo "test" >/dev/null 2>&1; then
            tmux display-popup -w "$POPUP_WIDTH" -h "$POPUP_HEIGHT" -E "$0 popup-content"
        else
            show_fallback
        fi
    else
        show_fallback
    fi
}

# Handle popup content execution
if [ "$1" = "popup-content" ]; then
    show_popup
else
    main "$@"
fi